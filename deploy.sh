#!/bin/bash

#############################################
# ã¾ã‚“2000 è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è‡ªå‹•çš„ã«Gitã«pushã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤
#############################################

set -e  # ã‚¨ãƒ©ãƒ¼ã§åœæ­¢

# ã‚«ãƒ©ãƒ¼å‡ºåŠ›
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# ãƒ­ã‚´è¡¨ç¤º
echo -e "${BLUE}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ã¾ã‚“2000 è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚·ã‚¹ãƒ†ãƒ       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"

# site-config.jsonã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
CONFIG_FILE="site-config.json"

if [ ! -f "$CONFIG_FILE" ]; then
    echo -e "${RED}âŒ ã‚¨ãƒ©ãƒ¼: site-config.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“${NC}"
    exit 1
fi

# jqãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
if ! command -v jq &> /dev/null; then
    echo -e "${YELLOW}âš ï¸ jqãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚brew install jq ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„${NC}"
    AUTO_DEPLOY="true"
else
    AUTO_DEPLOY=$(jq -r '.repository.auto_deploy // true' "$CONFIG_FILE")
fi

if [ "$AUTO_DEPLOY" != "true" ]; then
    echo -e "${YELLOW}â„¹ï¸ è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™${NC}"
    echo -e "${YELLOW}   site-config.json ã§ auto_deploy ã‚’ true ã«è¨­å®šã—ã¦ãã ã•ã„${NC}"
    exit 0
fi

# Step 1: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿çµ±åˆ
echo -e "${BLUE}ðŸ“Š Step 1: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆä¸­...${NC}"
node scripts/aggregate-metadata.js

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿çµ±åˆã«å¤±æ•—ã—ã¾ã—ãŸ${NC}"
    exit 1
fi

# Step 2: GitçŠ¶æ…‹ç¢ºèª
echo -e "\n${BLUE}ðŸ” Step 2: GitçŠ¶æ…‹ã‚’ç¢ºèªä¸­...${NC}"

if [ ! -d ".git" ]; then
    echo -e "${YELLOW}âš ï¸ Gitãƒªãƒã‚¸ãƒˆãƒªãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“${NC}"
    echo -e "${YELLOW}   ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:${NC}"
    echo -e "   ${GREEN}git init${NC}"
    echo -e "   ${GREEN}git remote add origin YOUR_REPO_URL${NC}"
    exit 1
fi

# ãƒªãƒ¢ãƒ¼ãƒˆURLã‚’ç¢ºèª
REMOTE_URL=$(git remote get-url origin 2>/dev/null || echo "")

if [ -z "$REMOTE_URL" ]; then
    echo -e "${YELLOW}âš ï¸ Gitãƒªãƒ¢ãƒ¼ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“${NC}"
    echo -e "${YELLOW}   site-config.json ã® remote_url ã‚’ç¢ºèªã—ã¦ãã ã•ã„${NC}"
    exit 1
fi

echo -e "${GREEN}âœ“ ãƒªãƒ¢ãƒ¼ãƒˆ: $REMOTE_URL${NC}"

# Step 3: å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
echo -e "\n${BLUE}ðŸ“¦ Step 3: å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ä¸­...${NC}"

git add .

# å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
if git diff --cached --quiet; then
    echo -e "${GREEN}âœ“ ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–°ã—ã„å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“${NC}"
    exit 0
fi

# å¤‰æ›´ã‚µãƒžãƒªãƒ¼ã‚’è¡¨ç¤º
echo -e "${GREEN}å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:${NC}"
git diff --cached --name-status | head -n 20

# Step 4: ã‚³ãƒŸãƒƒãƒˆ
echo -e "\n${BLUE}ðŸ’¾ Step 4: ã‚³ãƒŸãƒƒãƒˆä¸­...${NC}"

# æœ€æ–°ã®ãƒ†ãƒ¼ãƒžæƒ…å ±ã‚’å–å¾—ï¼ˆã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ï¼‰
LATEST_THEME=$(find . -name "metadata.json" -type f -exec stat -f "%m %N" {} + 2>/dev/null | sort -rn | head -1 | cut -d' ' -f2- | xargs -I {} dirname {})

if [ -n "$LATEST_THEME" ]; then
    THEME_NAME=$(basename "$LATEST_THEME")
    BOOK_NAME=$(basename "$(dirname "$LATEST_THEME")")
    COMMIT_MSG="Add new content: $BOOK_NAME - $THEME_NAME

ðŸ¤– Generated with Claude Code
Generated by ã¾ã‚“2000ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
Date: $(date '+%Y-%m-%d %H:%M:%S')"
else
    COMMIT_MSG="Update learning content

ðŸ¤– Generated with Claude Code
Generated by ã¾ã‚“2000ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
Date: $(date '+%Y-%m-%d %H:%M:%S')"
fi

git commit -m "$COMMIT_MSG"

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ ã‚³ãƒŸãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ${NC}"
    exit 1
fi

echo -e "${GREEN}âœ“ ã‚³ãƒŸãƒƒãƒˆå®Œäº†${NC}"

# Step 5: ãƒ—ãƒƒã‚·ãƒ¥
echo -e "\n${BLUE}ðŸš€ Step 5: ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥ä¸­...${NC}"

BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo -e "${BLUE}   ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH${NC}"

git push origin "$BRANCH"

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ã—ã¾ã—ãŸ${NC}"
    echo -e "${YELLOW}   åˆå›žãƒ—ãƒƒã‚·ãƒ¥ã®å ´åˆ: git push -u origin $BRANCH${NC}"
    exit 1
fi

# Step 6: Netlify Build Hookã‚’å‘¼ã³å‡ºã—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
if command -v jq &> /dev/null; then
    BUILD_HOOK=$(jq -r '.repository.netlify_build_hook // ""' "$CONFIG_FILE")

    if [ -n "$BUILD_HOOK" ] && [ "$BUILD_HOOK" != "null" ]; then
        echo -e "\n${BLUE}ðŸŒ Step 6: Netlifyãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒˆãƒªã‚¬ãƒ¼ä¸­...${NC}"

        RESPONSE=$(curl -X POST -s -w "\n%{http_code}" "$BUILD_HOOK")
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

        if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo -e "${GREEN}âœ“ Netlifyãƒ‡ãƒ—ãƒ­ã‚¤ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ${NC}"
            SITE_URL=$(jq -r '.site_info.base_url // "https://yoursite.com"' "$CONFIG_FILE")
            echo -e "${BLUE}   ã‚µã‚¤ãƒˆURL: $SITE_URL${NC}"
            echo -e "${YELLOW}   ãƒ“ãƒ«ãƒ‰çŠ¶æ³: https://app.netlify.com/sites/gregarious-tiramisu-baad37/deploys${NC}"
        else
            echo -e "${YELLOW}âš ï¸ Netlify Build Hookã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP $HTTP_CODE)${NC}"
            echo -e "${YELLOW}   æ‰‹å‹•ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„${NC}"
        fi
    fi
fi

# Step 7: å®Œäº†
echo -e "\n${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘     ðŸŽ‰ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼                â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

echo -e "\n${BLUE}ðŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±:${NC}"
echo -e "   ã‚³ãƒŸãƒƒãƒˆ: $(git rev-parse --short HEAD)"
echo -e "   ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH"
echo -e "   ãƒªãƒ¢ãƒ¼ãƒˆ: $REMOTE_URL"
echo -e "\n${GREEN}âœ… Netlifyã§ãƒ“ãƒ«ãƒ‰ãŒé€²è¡Œä¸­ã§ã™ï¼ˆ1-2åˆ†ï¼‰${NC}"
echo -e "${BLUE}   ã‚µã‚¤ãƒˆURL: $(jq -r '.site_info.base_url // "https://yoursite.com"' "$CONFIG_FILE" 2>/dev/null || echo "https://yoursite.com")${NC}\n"
